@page "/login"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Forms
@inject NavigationManager NavigationManager
@inject ALGASystem.Services.CustomAuthenticationStateProvider AuthStateProvider
@inject ILogger<Login> Logger

<PageTitle>Iniciar Sesión - Hermanas de la caridad del cardenal sancha</PageTitle>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="outlook-card mt-5">
            <div class="outlook-card-header text-center">
                <h3><i class="oi oi-account-login me-2"></i> Iniciar Sesión</h3>
            </div>
            <div class="outlook-card-body">
                <EditForm Model="@_loginModel" OnValidSubmit="HandleLogin">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            @_errorMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(_successMessage))
                    {
                        <div class="alert alert-success" role="alert">
                            @_successMessage
                        </div>
                    }

                    <div class="mb-3">
                        <label for="username" class="form-label">Usuario</label>
                        <InputText id="username" @bind-Value="_loginModel.UserName" class="form-control" />
                        <ValidationMessage For="@(() => _loginModel.UserName)" />
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <InputText id="password" type="password" @bind-Value="_loginModel.Password" class="form-control" />
                        <ValidationMessage For="@(() => _loginModel.Password)" />
                    </div>

                    <div class="mb-3 form-check">
                        <InputCheckbox id="rememberMe" @bind-Value="_loginModel.RememberMe" class="form-check-input" />
                        <label class="form-check-label" for="rememberMe">Recordarme</label>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="outlook-btn outlook-btn-primary">
                            <i class="oi oi-account-login me-2"></i> Iniciar Sesión
                        </button>
                    </div>
                </EditForm>

                <div class="mt-3 text-center">
                    <a href="/register" class="outlook-link">¿No tienes una cuenta? Regístrate</a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginModel _loginModel = new LoginModel();
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;

    protected override void OnInitialized()
    {
        // Check for query parameters
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("registered", out var registered))
        {
            _successMessage = "¡Registro exitoso! Ahora puedes iniciar sesión.";
        }
        
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("returnUrl", out var returnUrl))
        {
            Logger.LogInformation($"Página de inicio de sesión cargada con URL de retorno: {returnUrl}");
        }
    }

    private async Task HandleLogin()
    {
        try
        {
            Logger.LogInformation($"Intentando iniciar sesión para el usuario: {_loginModel.UserName}");
            
            // Usar el CustomAuthenticationStateProvider para validar el usuario
            var result = await AuthStateProvider.ValidateUserAsync(_loginModel.UserName, _loginModel.Password);
            
            if (result)
            {
                Logger.LogInformation($"Inicio de sesión exitoso para el usuario: {_loginModel.UserName}");
                
                // Verificar si hay una URL de retorno
                var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
                var returnUrl = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query)
                    .TryGetValue("returnUrl", out var url) ? url.ToString() : "/Dashboard";
                
                Logger.LogInformation($"Redirigiendo a: {returnUrl}");
                NavigationManager.NavigateTo(returnUrl);
            }
            else
            {
                Logger.LogWarning($"Inicio de sesión fallido para el usuario: {_loginModel.UserName}");
                _errorMessage = "Usuario o contraseña inválidos.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error durante el inicio de sesión");
            _errorMessage = "Ocurrió un error durante el inicio de sesión. Por favor, intente nuevamente.";
        }
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "El nombre de usuario es requerido")]
        public string UserName { get; set; }

        [Required(ErrorMessage = "La contraseña es requerida")]
        public string Password { get; set; }

        public bool RememberMe { get; set; } = false;
    }
}
